format_version: '11'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

workflows:
  ios:
    steps:
    - git-clone@8: {}
    - cache-pull@2: {}

    - npm@1:
        inputs:
        - command: install
        title: npm install

    - npm@1:
        title: Install Expo CLI
        inputs:
        - command: install -g expo-cli

    - script@1:
        title: Install CocoaPods
        inputs:
        - content: |-
            #!/bin/bash
            cd ios && pod install

    - script@1:
        title: Create Expo Dev Build
        inputs:
        - content: |-
            #!/bin/bash
            npx expo prebuild

    - script@1:
        title: Start Metro Bundler
        inputs:
        - content: |-
            #!/bin/bash
            npx expo start &
            sleep 10  # Give Metro some time to start up
            
    - script@1:
        title: Detox Build iOS
        inputs:
        - content: |-
            #!/bin/bash
            npm run test:e2e:build:ios

    - script@1:
        title: Detox Test iOS
        inputs:
        - content: |-
            #!/bin/bash
            npm run test:e2e:ios

    - cache-push@2: {}

  android:
    steps:
    - git-clone@8: {}
    - cache-pull@2: {}

    - java-setup@1:      
        inputs:
          java_version: "17"
          java_source: "adoptium"

    - npm@1:
        inputs:
        - command: install
        title: npm install

    - npm@1:
        title: Install Expo CLI
        inputs:
        - command: install -g expo-cli

    - script@1:
        title: Create Expo Dev Build
        inputs:
        - content: |-
            #!/bin/bash
            npx expo prebuild

    - install-missing-android-tools@3:
        inputs:
        - gradlew_path: $PROJECT_LOCATION/gradlew

    - android-build@1:
        inputs:
        - project_location: $PROJECT_LOCATION
        - module: app
        - variant: debugAndroidTest
        - build_type: debug
    
    - script@1:
        title: Start Metro Bundler
        inputs:
        - content: |-
            #!/bin/bash
            npx expo start &
            sleep 10  # Give Metro some time to start up

    - avd-manager@1:
        inputs:
        - api_level: "30"
        - profile: pixel_4

    - wait-for-android-emulator@1: {}

    - script@1:
        title: Detox Test Android
        inputs:
        - content: |-
            #!/bin/bash
            npm run test:e2e:android

    - cache-push@2: {}

app:
  envs:
  # iOS
  - BITRISE_PROJECT_PATH: ios/BitriseReactNativeDetoxSample.xcworkspace
  - BITRISE_SCHEME: BitriseReactNativeDetoxSample
  # Android
  - PROJECT_LOCATION: android
  - BITRISE_APK_PATH: android/app/build/outputs/apk/debug/app-debug.apk
  - ANDROID_HOME: /opt/android-sdk

meta:
  bitrise.io:
    stack: osx-xcode-16.2.x